#!/usr/bin/make -f

include /usr/share/dpkg/pkg-info.mk

NVIDIA_DIRECTORIES := $(shell find /usr/src/ -maxdepth 1 -type d -name 'nvidia-*')
NVIDIA_LATEST_VERSION := $(shell echo $(NVIDIA_DIRECTORIES) | tr ' ' '\n' | grep -Eo '[0-9]+\.[0-9]+\.[0-9]+' | sort -rV | head -n 1)

DEB_BUILD_OPTIONS ?= -j1

%:
	dh $@

override_dh_auto_clean:
	true

override_dh_auto_build:
	cp $(CURDIR)/debian/config-virt $(CURDIR)/.config
	make olddefconfig
	make $(DEB_BUILD_OPTIONS)

override_dh_auto_install:
	# Install Linux and its modules
	mkdir -p $(CURDIR)/debian/tmp/usr/lib/yagna/boot
	make INSTALL_PATH=$(CURDIR)/debian/tmp/usr/lib/yagna/boot INSTALL_MOD_PATH=$(CURDIR)/debian/tmp/usr/lib/yagna/ install modules_install

	# Build NVIDIA modules
	mkdir -p $(CURDIR)/debian/tmp/dkms
	SYSSRC=$(CURDIR) /sbin/dkms build -m nvidia-current -v $(NVIDIA_LATEST_VERSION) -k $(DEB_VERSION_UPSTREAM) \
		--kernelsourcedir $(CURDIR)/debian/tmp/usr/lib/yagna/lib/modules/$(DEB_VERSION_UPSTREAM)/build \
		--dkmstree $(CURDIR)/debian/tmp/dkms

	# Put NVIDIA modules into the modules tree
	mkdir -p $(CURDIR)/debian/tmp/usr/lib/yagna/lib/modules/$(DEB_VERSION_UPSTREAM)/updates/dkms
	mv $(CURDIR)/debian/tmp/dkms/nvidia-current/$(NVIDIA_LATEST_VERSION)/$(DEB_VERSION_UPSTREAM)/x86_64/module/*.ko \
		$(CURDIR)/debian/tmp/usr/lib/yagna/lib/modules/$(DEB_VERSION_UPSTREAM)/updates/dkms

	# Cleanup
	rm -rf $(CURDIR)/debian/tmp/usr/lib/yagna/lib/modules/$(DEB_VERSION_UPSTREAM)/source \
		$(CURDIR)/debian/tmp/usr/lib/yagna/lib/modules/$(DEB_VERSION_UPSTREAM)/build \
		$(CURDIR)/debian/tmp/dkms
